<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” êµí™˜ì†Œ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    [v-cloak] { display: none !important; }
    body { background-color: #eef2f6; font-family: 'Apple SD Gothic Neo', sans-serif; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ec4899; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .btn-press:active { transform: scale(0.95); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .gauge-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-disabled { background-color: #d1d5db !important; color: #9ca3af !important; cursor: not-allowed; transform: none !important; }
  </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative flex flex-col overflow-hidden">

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div v-if="!isLoggedIn" class="p-8 flex flex-col justify-center h-screen bg-pink-50 relative">
    <button @click="showHelpPopup = true" class="absolute top-4 right-4 text-gray-400 text-sm flex flex-col items-center">
      <i class="fas fa-question-circle text-xl mb-1"></i><span class="text-xs">ë„ì›€ë§</span>
    </button>

    <div class="text-center mb-10">
      <span class="text-4xl">ğŸ‘¸</span>
      <h1 class="text-3xl font-bold text-pink-600 mt-2">ì˜¤í”¼ìŠ¤í€¸<br>ì•¨ë²” êµí™˜ì†Œ</h1>
    </div>

    <div class="space-y-4">
      <input v-model="loginForm.server" type="number" placeholder="ì„œë²„ ë²ˆí˜¸ (ìˆ«ì)"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.nickname" type="text" placeholder="ë‹‰ë„¤ì„ (ê´€ë¦¬ìëŠ” 'ê´€ë¦¬ì')"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.password" type="password" maxlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">

      <button @click="handleLogin"
              class="w-full bg-gradient-to-r from-pink-500 to-pink-400 text-white p-4 rounded-xl font-bold hover:from-pink-600 hover:to-pink-500 transition shadow-md flex justify-center items-center"
              :disabled="isLoading">
        <div v-if="isLoading" class="loader mr-2 border-white border-t-transparent"></div>
        <span>{{ isLoading ? 'ë¡œë”©ì¤‘...' : 'ì…ì¥í•˜ê¸°' }}</span>
      </button>
    </div>

    <p class="text-xs text-gray-400 text-center mt-6">ì„œë²„/ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
  </div>

  <!-- ì•± ë³¸ë¬¸ -->
  <div v-else class="flex flex-col h-screen bg-[#f0f9ff]">

    <!-- ìƒë‹¨ë°” -->
    <div class="sticky top-0 bg-white/90 backdrop-blur-sm z-20 border-b border-blue-100 p-3 shadow-sm flex-none">
      <div class="flex justify-between items-center mb-2">
        <div class="flex flex-col">
          <span class="font-bold text-gray-700 text-sm flex items-center">
            <span v-if="isAdmin" class="text-red-500 mr-1 text-lg">ğŸ‘‘</span>
            <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs mr-1 font-bold">
              S{{ userData.server }}
            </span>
            {{ userData.nickname }}ë‹˜
          </span>

          <span class="text-[10px] font-bold mt-1" :class="tradeCount >= 3 ? 'text-red-500' : 'text-green-600'">
            <i class="fas fa-sync-alt mr-1"></i>
            ì˜¤ëŠ˜ êµí™˜ {{ tradeCount }}/3 {{ tradeCount >= 3 ? '(ë§ˆê°)' : '' }}
          </span>
        </div>

        <div class="flex gap-2 items-center">
          <button @click="showHelpPopup = true" class="text-gray-400 hover:text-blue-500">
            <i class="fas fa-question-circle text-lg"></i>
          </button>

          <button @click="fetchUsersAndShowList"
                  class="text-xs bg-blue-500 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm hover:bg-blue-600 transition">
            ğŸ‘¥ ë©¤ë²„
          </button>

          <template v-if="isAdmin">
            <button @click="openAdminTool"
                    class="text-xs bg-yellow-500 text-white px-2 py-1.5 rounded-lg shadow-sm font-bold">
              ğŸ‘‘ ë„êµ¬
            </button>
            <button @click="showAdminPopup = true"
                    class="text-xs bg-gray-600 text-white px-2 py-1.5 rounded-lg shadow-sm">
              âš™ï¸
            </button>
          </template>

          <button @click="logout" class="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">
            ë‚˜ê°€ê¸°
          </button>
        </div>
      </div>

      <div class="relative w-full h-7 bg-gray-200 rounded-full shadow-inner overflow-hidden border border-gray-300">
        <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 gauge-fill"
             :style="{ width: totalProgress + '%' }"></div>
        <div class="absolute inset-0 flex items-center justify-center text-xs font-extrabold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.6)] z-10">
          ì „ì²´ ìˆ˜ì§‘ë¥  {{ totalCount }}/81 ({{ totalProgress }}%)
        </div>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="flex-1 overflow-y-auto hide-scroll p-4 pb-20">

      <!-- ëŒ€ì‹œë³´ë“œ -->
      <div v-if="currentView === 'dashboard'" class="grid grid-cols-3 gap-x-2 gap-y-6">
        <div v-for="(album, idx) in appConfig.albumNames"
             :key="idx"
             @click="openAlbum(idx)"
             class="flex flex-col items-center cursor-pointer group">

          <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg overflow-hidden relative bg-white group-hover:scale-105 transition duration-200 ring-2 ring-gray-100">
            <img v-if="appConfig.albumCovers && appConfig.albumCovers[idx]" :src="appConfig.albumCovers[idx]" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center bg-blue-50 text-3xl text-blue-200">ğŸ“</div>
            <div v-if="getAlbumCount(idx) === 9" class="absolute inset-0 bg-black/30 flex items-center justify-center">
              <i class="fas fa-check text-2xl text-green-400 drop-shadow-md"></i>
            </div>
          </div>

          <div class="mt-2 mb-1 px-2 py-0.5 rounded bg-white/50 backdrop-blur-sm">
            <span class="text-[11px] font-bold text-gray-700 text-center block truncate max-w-[80px]">{{ album }}</span>
          </div>

          <div class="w-20 h-4 bg-gray-600 rounded-full relative border border-white shadow-sm overflow-hidden">
            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full gauge-fill"
                 :style="{ width: (getAlbumCount(idx) / 9) * 100 + '%' }"></div>
            <span class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-[0_1px_1px_rgba(0,0,0,0.5)]">
              {{ getAlbumCount(idx) }}/9
            </span>
          </div>

        </div>
      </div>

      <!-- ìƒì„¸ -->
      <div v-if="currentView === 'detail'">
        <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-xl shadow-sm border border-blue-100">
          <button @click="prevAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h2 class="text-sm font-bold text-gray-800">{{ appConfig.albumNames[currentAlbumIdx] }}</h2>
          <button @click="nextAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="grid grid-cols-3 gap-1.5">
          <div v-for="(count, i) in currentAlbumCards" :key="i"
               class="bg-white rounded-lg p-1.5 shadow-sm border border-gray-100 flex flex-col h-28 relative">
            <div class="flex-1 bg-gray-50 rounded mb-1.5 relative overflow-hidden cursor-pointer border border-gray-200 group"
                 @click="checkExchange(i)">
              <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                <span class="text-[9px]">ì‚¬ì§„</span>
                <span class="text-xs font-bold">{{ i + 1 }}</span>
              </div>
              <div v-if="count === 0"
                   class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-red-500 font-bold z-10 group-hover:bg-white/70 transition">
                <i class="fas fa-search text-lg mb-1"></i>
                <span class="text-[9px]">êµ¬í•´ìš”</span>
              </div>
            </div>

            <div class="flex items-center justify-between bg-gray-50 rounded-full p-0.5 border border-gray-200">
              <button @click="updateCount(i, -1)"
                      class="w-5 h-5 rounded-full bg-white shadow-sm text-gray-500 flex items-center justify-center text-xs border border-gray-200 btn-press font-bold">-</button>
              <span class="flex-1 text-center text-xs font-bold" :class="count > 0 ? 'text-blue-600' : 'text-gray-300'">{{ count }}</span>
              <button @click="updateCount(i, 1)"
                      class="w-5 h-5 rounded-full bg-blue-500 shadow-sm text-white flex items-center justify-center text-xs btn-press font-bold border-none">+</button>
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-center">
          <button @click="currentView = 'dashboard'"
                  class="px-6 py-2 bg-gray-800 text-white text-xs rounded-full font-bold shadow-lg hover:bg-gray-700 transition flex items-center">
            <i class="fas fa-th-large mr-2"></i> ì•¨ë²” ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- ê´€ë¦¬ì: VIP ëª°ì•„ì£¼ê¸° -->
  <div v-if="showAdminToolPopup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" @click.self="showAdminToolPopup = false">
    <div class="bg-gray-900 rounded-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto text-white shadow-2xl border border-gray-700">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-yellow-400">ğŸ‘‘ VIP ì¹´ë“œ ëª°ì•„ì£¼ê¸°</h2>
        <button @click="showAdminToolPopup = false" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="mb-6">
        <label class="block text-xs text-gray-400 mb-2">ëˆ„êµ¬ì—ê²Œ ì¹´ë“œë¥¼ ëª°ì•„ì¤„ê¹Œìš”? (ë°›ëŠ” ì‚¬ëŒ)</label>
        <select v-model="adminTargetUserId" @change="calculateAdminMatches"
                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-yellow-500">
          <option value="" disabled>ì„ íƒí•´ì£¼ì„¸ìš”</option>
          <option v-for="user in adminUserList" :key="user.id" :value="user.id">
            S{{ user.server }} {{ user.nickname }} (í˜„ì¬ {{ user.totalCount }}/81)
          </option>
        </select>
      </div>

      <div v-if="adminTargetUserId">
        <h3 class="text-sm font-bold text-gray-300 mb-3 pl-2 border-l-4 border-yellow-500">ë°œê²¬ëœ ì‰ì—¬ ìì› (ì¤„ ìˆ˜ ìˆëŠ” ì‚¬ëŒë“¤)</h3>

        <div v-if="adminMatchList.length === 0" class="text-center py-10 text-gray-500 bg-gray-800 rounded-lg border border-gray-700">
          <div class="text-2xl mb-2">ğŸ¤·â€â™‚ï¸</div>ì¤„ ìˆ˜ ìˆëŠ” ì¹´ë“œê°€ ì—†ê±°ë‚˜, ì´ë¯¸ ë‹¤ ëª¨ìœ¼ì…¨ë„¤ìš”!
        </div>

        <div v-else class="space-y-3">
          <div v-for="(match, idx) in adminMatchList" :key="idx" class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg">
            <div class="flex justify-between items-start mb-3">
              <div>
                <span class="text-xs text-blue-400 font-bold block mb-1">ì£¼ëŠ” ì‚¬ëŒ (Donor)</span>
                <span class="text-lg font-bold">S{{ match.user.server }} {{ match.user.nickname }}</span>
              </div>

              <button @click="executeAdminTransfer(match)"
                      class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-4 py-2 rounded text-xs shadow-md transition flex items-center">
                <i class="fas fa-bolt mr-1"></i> {{ match.giveable.length }}ì¥ ê°€ì ¸ì˜¤ê¸°
              </button>
            </div>

            <div class="bg-gray-900 rounded p-2 text-xs text-gray-400">
              <div class="flex flex-wrap gap-1">
                <span v-for="(card, cIdx) in match.giveable" :key="cIdx"
                      class="bg-gray-700 text-gray-200 px-2 py-1 rounded border border-gray-600">
                  {{ card.name }}
                </span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div v-else class="text-center py-10 text-gray-600">ìœ„ì—ì„œ <b>ë°›ì„ ì‚¬ëŒ</b>ì„ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ì„¤ì • íŒì—… -->
  <div v-if="showAdminPopup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">ğŸ›  ì„¤ì •</h2>
        <button @click="showAdminPopup = false" class="text-gray-500"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="space-y-6 mb-8">
        <div v-for="(name, idx) in appConfig.albumNames" :key="idx" class="border-b pb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">ì•¨ë²” {{ idx + 1 }}</label>
          <div class="grid grid-cols-1 gap-2">
            <input v-model="appConfig.albumNames[idx]" type="text" class="w-full p-2 border rounded text-sm">
            <input v-model="appConfig.albumCovers[idx]" type="text" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ"
                   class="w-full p-2 border rounded text-sm text-gray-500">
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 mb-8">
        <button @click="saveAppConfig" class="px-6 py-3 bg-blue-600 text-white rounded font-bold w-full">ì €ì¥</button>
      </div>

      <div class="border-t-2 border-red-100 pt-6 mt-6 bg-red-50 p-4 rounded-lg">
        <button @click="resetAllUsers" class="w-full bg-red-500 text-white py-3 rounded font-bold">ğŸ§¨ ì‹œì¦Œ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ -->
  <div v-if="showUserListPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showUserListPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[80vh] overflow-y-auto shadow-2xl">
      <button @click="showUserListPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500">
        <i class="fas fa-times"></i>
      </button>

      <h3 class="text-base font-bold mb-4 text-gray-800">ğŸ‘¥ í™œë™ ë©¤ë²„ <span class="text-blue-500">{{ filteredUserList.length }}ëª…</span></h3>

      <div class="mb-3 relative">
        <input v-model="searchKeyword" type="text" placeholder="ë‹‰ë„¤ì„ / ì„œë²„ ê²€ìƒ‰"
               class="w-full p-2.5 pl-9 border border-gray-200 rounded-xl text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-100 transition">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
      </div>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else class="space-y-2">
        <div v-for="user in filteredUserList" :key="user.id" @click="openCompare(user)"
             class="border border-gray-100 p-3 rounded-xl flex justify-between items-center hover:bg-blue-50 hover:border-blue-100 cursor-pointer transition group">
          <div class="flex items-center">
            <div class="w-2 h-2 rounded-full mr-2" :class="getActiveColor(user.lastUpdated)"></div>

            <span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-2">
              S{{ user.server }}
            </span>

            <div class="flex flex-col">
              <span class="font-bold text-gray-700 text-sm group-hover:text-blue-600 flex items-center">
                {{ user.nickname }}
                <i v-if="user.totalCount >= 81" class="fas fa-trophy text-yellow-500 ml-1 text-xs"></i>
              </span>

              <div class="flex items-center gap-2">
                <span class="text-[9px] text-gray-400">
                  <i class="fas fa-history mr-0.5"></i>{{ getTimeAgo(user.lastUpdated) }}
                </span>
                <span class="text-[10px] px-1.5 rounded-full"
                      :class="user.totalCount >= 40 ? 'bg-pink-100 text-pink-600 font-bold' : 'bg-gray-100 text-gray-500'">
                  {{ user.totalCount || 0 }}/81
                </span>
              </div>
            </div>
          </div>

          <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 group-hover:bg-blue-200 group-hover:text-blue-700 transition">
            ë¹„êµ >
          </span>
        </div>

        <div v-if="filteredUserList.length === 0" class="text-center text-gray-400 py-8 text-xs bg-gray-50 rounded-xl">
          {{ searchKeyword ? 'ê²€ìƒ‰ëœ ë©¤ë²„ê°€ ì—†ì–´ìš”.' : 'í™œë™ ì¤‘ì¸ ë©¤ë²„ê°€ ì—†ì–´ìš”.' }}
        </div>
      </div>
    </div>
  </div>

  <!-- ë¹„êµ íŒì—… -->
  <div v-if="showComparePopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showComparePopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[85vh] overflow-y-auto shadow-2xl">
      <button @click="showComparePopup = false" class="absolute top-3 right-3 text-gray-300 hover:text-gray-500">
        <i class="fas fa-times"></i>
      </button>

      <div class="text-center mb-5 mt-2">
        <div class="text-xs text-gray-400 mb-1">ë‚˜ vs ìƒëŒ€ë°©</div>
        <h3 class="text-lg font-bold text-gray-800 flex justify-center items-center">
          S{{ compareTarget?.server }} {{ compareTarget?.nickname }}
        </h3>
      </div>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else class="space-y-3">
        <!-- ìœˆìœˆ -->
        <div v-if="compareResult.mutual.give.length > 0 || compareResult.mutual.receive.length > 0" class="bg-red-50 p-3 rounded-xl border border-red-100">
          <h4 class="font-bold text-red-500 text-xs mb-2 flex items-center"><i class="fas fa-heart mr-1"></i> ìœˆìœˆ (ì„œë¡œ í•„ìš”í•´!)</h4>

          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.mutual.give" :key="'m_g_'+idx"
                 class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50">
              <span class="truncate max-w-[55%] text-gray-600">
                ë‚´ê°€ <span class="font-bold text-blue-500">ì¤Œ</span>: {{ card.name }}
              </span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">
                  <i class="far fa-copy"></i> ë³µì‚¬
                </button>
                <button @click="executeTrade(card, 'give')"
                        class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded shadow-sm"
                        :class="{'btn-press': tradeCount < 3, 'btn-disabled': tradeCount >= 3}"
                        :disabled="tradeCount >= 3">
                  ë³´ë‚´ê¸°
                </button>
              </div>
            </div>

            <div v-for="(card, idx) in compareResult.mutual.receive" :key="'m_r_'+idx"
                 class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50">
              <span class="truncate max-w-[55%] text-gray-600">
                ë‚´ê°€ <span class="font-bold text-red-500">ë°›ìŒ</span>: {{ card.name }}
              </span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">
                  <i class="far fa-copy"></i> ë³µì‚¬
                </button>
                <button @click="executeTrade(card, 'receive')"
                        class="text-[10px] bg-red-500 text-white px-2 py-1 rounded shadow-sm"
                        :class="{'btn-press': tradeCount < 3, 'btn-disabled': tradeCount >= 3}"
                        :disabled="tradeCount >= 3">
                  ë°›ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ê¸°ë¶€ ê°€ëŠ¥ -->
        <div v-if="compareResult.giveOnly.length > 0" class="bg-blue-50 p-3 rounded-xl border border-blue-100">
          <h4 class="font-bold text-blue-500 text-xs mb-2 flex items-center"><i class="fas fa-gift mr-1"></i> ê¸°ë¶€ ê°€ëŠ¥ (ë‚˜ëŠ” ë‚¨ì•„ìš”)</h4>
          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.giveOnly" :key="'g_'+idx"
                 class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-blue-50">
              <span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">
                  <i class="far fa-copy"></i> ë³µì‚¬
                </button>
                <button @click="executeTrade(card, 'give')"
                        class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded shadow-sm"
                        :class="{'btn-press': tradeCount < 3, 'btn-disabled': tradeCount >= 3}"
                        :disabled="tradeCount >= 3">
                  ë³´ë‚´ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- êµ¬í•´ìš” -->
        <div v-if="compareResult.receiveOnly.length > 0" class="bg-gray-100 p-3 rounded-xl border border-gray-200">
          <h4 class="font-bold text-gray-500 text-xs mb-2 flex items-center"><i class="fas fa-hand-holding mr-1"></i> êµ¬í•´ìš” (ìƒëŒ€ëŠ” ë‚¨ì•„ìš”)</h4>
          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.receiveOnly" :key="'r_'+idx"
                 class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-gray-100">
              <span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">
                  <i class="far fa-copy"></i> ë³µì‚¬
                </button>
                <button @click="executeTrade(card, 'receive')"
                        class="text-[10px] bg-green-500 text-white px-2 py-1 rounded shadow-sm"
                        :class="{'btn-press': tradeCount < 3, 'btn-disabled': tradeCount >= 3}"
                        :disabled="tradeCount >= 3">
                  ë°›ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="compareResult.giveOnly.length === 0 && compareResult.receiveOnly.length === 0 && compareResult.mutual.give.length === 0 && compareResult.mutual.receive.length === 0"
             class="text-center text-gray-400 text-xs py-8 bg-gray-50 rounded-xl">
          êµí™˜í•  ìˆ˜ ìˆëŠ” ì¹´ë“œê°€ ì—†ì–´ìš” ğŸ˜…
        </div>
      </div>
    </div>
  </div>

  <!-- êµí™˜ ë„ìš°ë¯¸(ì¹´ë“œ 0ì¼ ë•Œ í´ë¦­) -->
  <div v-if="showPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
      <button @click="showPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>

      <h3 class="text-lg font-bold mb-1 text-gray-800">ğŸ¤ êµí™˜ ë„ìš°ë¯¸</h3>
      <p class="text-xs text-gray-500 mb-6 border-b pb-2">
        <span class="text-pink-600 font-bold">{{ appConfig.albumNames[currentAlbumIdx] }} - ì‚¬ì§„{{ targetCardIdx + 1 }}</span> ë³´ìœ ì ì°¾ê¸°
      </p>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else-if="exchangeList.length === 0" class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl">
        <div class="text-2xl mb-2">ğŸ˜­</div>ì—¬ìœ ë¶„ ìˆëŠ” ì¹œêµ¬ê°€ ì—†ì–´ìš”
      </div>

      <div v-else class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
        <div v-for="user in exchangeList" :key="user.id" class="border border-gray-100 p-3 rounded-xl bg-white shadow-sm flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <div class="font-bold text-gray-700 text-sm">
              <span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-1">S{{ user.server }}</span>
              {{ user.nickname }}
            </div>
            <button @click="openCompare(user)" class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded shadow-sm">ì „ì²´ ë¹„êµ</button>
          </div>

          <div v-if="user.giveable.length > 0" class="bg-blue-50 p-2 rounded-lg">
            <div class="text-[10px] text-blue-500 font-bold mb-1 flex items-center">
              <i class="fas fa-gift mr-1"></i> ë‚˜ë„ ì¤„ ìˆ˜ ìˆëŠ” ê²ƒ:
            </div>
            <div class="flex flex-wrap gap-1">
              <span v-for="(card, cIdx) in user.giveable" :key="cIdx"
                    class="text-[9px] bg-white border border-blue-100 px-1.5 py-0.5 rounded text-gray-500">
                {{ card }}
              </span>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ -->
  <div v-if="showHelpPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showHelpPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
      <button @click="showHelpPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times text-xl"></i></button>
      <h3 class="text-lg font-bold text-gray-800 mb-6 text-center">ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</h3>

      <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 text-center">
        <span class="text-red-600 font-bold text-xs block mb-1">âš ï¸ ì£¼ì˜ì‚¬í•­ (í•„ë…)</span>
        <p class="text-xs text-red-500 leading-tight">
          ì´ ì•±ì€ <b>ì¥ë¶€</b>ì¼ ë¿ì…ë‹ˆë‹¤!<br>
          ê±°ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ ê²Œì„ ì•„ì´í…œì€ ì´ë™í•˜ì§€ ì•Šì•„ìš”.<br>
          <b>ë°˜ë“œì‹œ ê²Œì„ì—ì„œ ë¨¼ì € êµí™˜í•˜ê³ </b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </p>
      </div>

      <div class="space-y-4 text-sm text-gray-600">
        <div class="flex items-start">
          <div class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">1</div>
          <div><span class="font-bold text-gray-800 block mb-0.5">ì¹´ë“œ ì…ë ¥</span>ì•¨ë²”ì—ì„œ <code>+</code> <code>-</code> ë¡œ ìˆ˜ëŸ‰ ì…ë ¥ (ìë™ ì €ì¥)</div>
        </div>
        <div class="flex items-start">
          <div class="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">2</div>
          <div><span class="font-bold text-gray-800 block mb-0.5">1:1 ë§êµí™˜</span>ë©¤ë²„ì—ì„œ <code>ë¹„êµ ></code>ë¡œ ì„œë¡œ ìœˆìœˆ ì¹´ë“œ í™•ì¸</div>
        </div>
        <div class="flex items-start">
          <div class="bg-gray-100 text-gray-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">3</div>
          <div><span class="font-bold text-gray-800 block mb-0.5">ë³µì‚¬ & ë¶™ì—¬ë„£ê¸°</span><code>ë³µì‚¬</code> ëˆŒëŸ¬ ê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸°</div>
        </div>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-100 text-center">
        <p class="text-xs text-gray-400">ğŸš« ì˜¤ë¥˜ ì œë³´ ë° ë¬¸ì˜: <span class="font-bold text-pink-500">67ì„­ ì‹œì†Œ</span></p>
      </div>

      <button @click="showHelpPopup = false" class="w-full bg-gray-800 text-white py-3 rounded-xl mt-4 font-bold text-sm hover:bg-gray-700">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
    </div>
  </div>

</div>

<script>
  // ====== Firebase ì„¤ì • ======
  const firebaseConfig = {
    apiKey: "AIzaSyCFV593GWa2VoOf4IqMhVmbW2BGQqkDsE4",
    authDomain: "office-queen-album.firebaseapp.com",
    projectId: "office-queen-album",
    storageBucket: "office-queen-album.firebasestorage.app",
    messagingSenderId: "936201723618",
    appId: "1:936201723618:web:e4ec53040d668f023988bb",
    measurementId: "G-CEENHZG8HZ"
  };

  const ADMIN_PASSWORD = "1299";
  const ADMIN_DOC_ID = "MASTER_ADMIN";
  const STORAGE_KEY = "oq_user_v5";

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const { createApp, ref, computed } = Vue;

  createApp({
    setup() {
      // ====== state ======
      const isLoggedIn = ref(false);
      const isLoading = ref(false);

      const currentView = ref('dashboard'); // dashboard | detail
      const currentAlbumIdx = ref(0);

      const loginForm = ref({ server: '', nickname: '', password: '' });

      const userData = ref(null);
      const tradeCount = ref(0);

      const showPopup = ref(false);
      const showUserListPopup = ref(false);
      const showComparePopup = ref(false);
      const showAdminPopup = ref(false);
      const showHelpPopup = ref(false);
      const showAdminToolPopup = ref(false);

      const targetCardIdx = ref(0);
      const exchangeList = ref([]);

      const userList = ref([]);
      const searchKeyword = ref('');

      const compareTarget = ref(null);
      const compareResult = ref({ mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] });

      const adminUserList = ref([]);
      const adminTargetUserId = ref('');
      const adminMatchList = ref([]);

      const appConfig = ref({
        albumNames: Array(9).fill().map((_, i) => `ì•¨ë²” ${i+1}`),
        albumCovers: Array(9).fill("")
      });

      // ====== helpers ======
      const isAdmin = computed(() => !!userData.value && userData.value.role === 'admin');

      const normalizeCollection = (col) => {
        // colì´ ì´ìƒí•˜ë©´ 81ì¹¸ 0ìœ¼ë¡œ ë³´ì •
        if (!Array.isArray(col)) return Array(81).fill(0);
        // í˜¹ì‹œ 2ì¤‘ë°°ì—´ ê°™ì€ ì´ìƒì¹˜ ì œê±°
        if (Array.isArray(col[0])) return Array(81).fill(0);
        const fixed = col.slice(0, 81).map(v => (typeof v === 'number' ? v : 0));
        while (fixed.length < 81) fixed.push(0);
        return fixed;
      };

      const getMyDocId = () => {
        if (!userData.value) return null;
        return userData.value.role === 'admin'
          ? ADMIN_DOC_ID
          : `S${userData.value.server}_${userData.value.nickname}`;
      };

      // ê²Œì„ ë‚ ì§œ(ì˜¤ì „ 8ì‹œ ê¸°ì¤€ ë¦¬ì…‹)
      const getGameDate = () => {
        const now = new Date();
        if (now.getHours() < 8) now.setDate(now.getDate() - 1);
        return now.toISOString().split('T')[0];
      };

      const asDate = (timestamp) => {
        if (!timestamp) return null;
        try {
          if (timestamp.toDate && typeof timestamp.toDate === 'function') return timestamp.toDate();
          if (timestamp instanceof Date) return timestamp;
          if (typeof timestamp === 'number') return new Date(timestamp);
          return null;
        } catch {
          return null;
        }
      };

      const getTimeAgo = (timestamp) => {
        const date = asDate(timestamp);
        if (!date) return 'ê¸°ë¡ ì—†ìŒ';
        const diff = Date.now() - date.getTime();
        const min = 60 * 1000, hour = 60 * min, day = 24 * hour;
        if (diff < 10 * min) return 'ë°©ê¸ˆ ì „';
        if (diff < hour) return `${Math.floor(diff / min)}ë¶„ ì „`;
        if (diff < day) return `${Math.floor(diff / hour)}ì‹œê°„ ì „`;
        return `${Math.floor(diff / day)}ì¼ ì „`;
      };

      const getActiveColor = (timestamp) => {
        const date = asDate(timestamp);
        if (!date) return 'bg-gray-300';
        const diff = Date.now() - date.getTime();
        if (diff < 60 * 60 * 1000) return 'bg-green-500';
        if (diff < 24 * 60 * 60 * 1000) return 'bg-yellow-400';
        return 'bg-gray-300';
      };

      const totalCount = computed(() => {
        if (!userData.value) return 0;
        const col = normalizeCollection(userData.value.collection);
        return col.filter(c => c > 0).length;
      });

      const totalProgress = computed(() => Math.round((totalCount.value / 81) * 100));

      const currentAlbumCards = computed(() => {
        if (!userData.value) return [];
        const col = normalizeCollection(userData.value.collection);
        return col.slice(currentAlbumIdx.value * 9, currentAlbumIdx.value * 9 + 9);
      });

      const getAlbumCount = (idx) => {
        if (!userData.value) return 0;
        const col = normalizeCollection(userData.value.collection);
        return col.slice(idx * 9, idx * 9 + 9).filter(c => c > 0).length;
      };

      // ====== config ======
      const loadAppConfig = async () => {
        try {
          const doc = await db.collection('config').doc('service_info').get();
          if (doc.exists) {
            const data = doc.data() || {};
            if (Array.isArray(data.albumNames) && data.albumNames.length === 9) appConfig.value.albumNames = data.albumNames;
            if (Array.isArray(data.albumCovers) && data.albumCovers.length === 9) appConfig.value.albumCovers = data.albumCovers;
          }
        } catch (e) {
          console.warn("config load fail", e);
        }
      };

      const saveAppConfig = async () => {
        if (!confirm("ì €ì¥í• ê¹Œìš”?")) return;
        try {
          await db.collection('config').doc('service_info').set(appConfig.value);
          alert("ì €ì¥ë¨");
          showAdminPopup.value = false;
        } catch (e) {
          alert("ì‹¤íŒ¨: " + (e.message || e));
        }
      };

      // ====== daily limit ======
      const checkAndResetDailyLimit = async () => {
        if (!userData.value || isAdmin.value) return;
        const today = getGameDate();

        const curDate = userData.value.dailyExchangeDate;
        const curCount = userData.value.dailyExchangeCount || 0;

        if (curDate !== today) {
          userData.value.dailyExchangeDate = today;
          userData.value.dailyExchangeCount = 0;
          tradeCount.value = 0;

          const docId = getMyDocId();
          if (docId) {
            try {
              await db.collection('users').doc(docId).update({
                dailyExchangeDate: today,
                dailyExchangeCount: 0
              });
            } catch {}
          }
        } else {
          tradeCount.value = curCount;
        }
      };

      // ====== activity ======
      const updateLastActive = async () => {
        if (!userData.value || isAdmin.value) return;
        const docId = getMyDocId();
        if (!docId) return;
        try {
          await db.collection('users').doc(docId).update({
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch {}
      };

      // ====== auth ======
      const persistUser = () => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(userData.value));
        } catch {}
      };

      const clearUser = () => {
        try { localStorage.removeItem(STORAGE_KEY); } catch {}
      };

      const handleLogin = async () => {
        if (isLoading.value) return;

        const server = String(loginForm.value.server || '').trim();
        const nickname = String(loginForm.value.nickname || '').trim();
        const password = String(loginForm.value.password || '').trim();

        if (!nickname || !password) {
          alert("ì •ë³´ ì…ë ¥!");
          return;
        }

        isLoading.value = true;

        try {
          await loadAppConfig();

          // ê´€ë¦¬ì
          if (nickname === 'ê´€ë¦¬ì') {
            if (password !== ADMIN_PASSWORD) {
              alert("ë¹„ë²ˆ í‹€ë¦¼");
              return;
            }
            await processLogin(ADMIN_DOC_ID, {
              server: 0,
              nickname: 'ê´€ë¦¬ì',
              password: ADMIN_PASSWORD,
              role: 'admin'
            });
            return;
          }

          // ì¼ë°˜ ìœ ì €
          if (!server) {
            alert("ì„œë²„ ì…ë ¥!");
            return;
          }

          const docId = `S${server}_${nickname}`;
          await processLogin(docId, {
            server: Number(server),
            nickname,
            password,
            role: 'user'
          });

        } catch (e) {
          console.error(e);
          alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const processLogin = async (docId, userInfo) => {
        const docRef = db.collection('users').doc(docId);
        const doc = await docRef.get();

        let finalData;

        if (doc.exists) {
          const data = doc.data() || {};

          // ë¹„ë²ˆ ì²´í¬(ê´€ë¦¬ì ì œì™¸ëŠ” ìœ„ì—ì„œ ì´ë¯¸)
          if (userInfo.role !== 'admin') {
            if (String(data.password || '') !== String(userInfo.password)) {
              alert("ë¹„ë²ˆ í‹€ë¦¼");
              return;
            }
          }

          finalData = {
            ...data,
            server: data.server ?? userInfo.server,
            nickname: data.nickname ?? userInfo.nickname,
            role: data.role ?? userInfo.role,
            password: data.password ?? userInfo.password,
            collection: normalizeCollection(data.collection)
          };

        } else {
          // ì‹ ê·œ ê°€ì…
          finalData = {
            ...userInfo,
            collection: Array(81).fill(0),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            dailyExchangeCount: 0,
            dailyExchangeDate: getGameDate()
          };
          await docRef.set(finalData);
        }

        userData.value = finalData;
        persistUser();

        isLoggedIn.value = true;
        currentView.value = 'dashboard';

        if (!isAdmin.value) {
          await checkAndResetDailyLimit();
          updateLastActive();
        } else {
          // ê´€ë¦¬ì íŒ¨ë„ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ
          fetchAdminData();
        }
      };

      const checkLogin = async () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;

        try {
          const parsed = JSON.parse(saved);
          if (!parsed || !parsed.nickname) return;

          userData.value = {
            ...parsed,
            collection: normalizeCollection(parsed.collection)
          };

          await loadAppConfig();
          isLoggedIn.value = true;

          if (!isAdmin.value) {
            await checkAndResetDailyLimit();
            updateLastActive();
          } else {
            fetchAdminData();
          }
        } catch (e) {
          console.warn("auto login fail", e);
        }
      };

      const logout = () => {
        clearUser();
        userData.value = null;
        isLoggedIn.value = false;
        loginForm.value = { server: '', nickname: '', password: '' };
        tradeCount.value = 0;
        currentView.value = 'dashboard';
      };

      // ====== navigation ======
      const openAlbum = (idx) => {
        currentAlbumIdx.value = idx;
        currentView.value = 'detail';
      };
      const prevAlbum = () => { if (currentAlbumIdx.value > 0) currentAlbumIdx.value--; };
      const nextAlbum = () => { if (currentAlbumIdx.value < 8) currentAlbumIdx.value++; };

      // ====== card update ======
      const updateCount = (i, chg) => {
        if (!userData.value) return;
        const col = normalizeCollection(userData.value.collection);

        const realIdx = currentAlbumIdx.value * 9 + i;
        const next = (col[realIdx] || 0) + chg;
        if (next < 0) return;

        col[realIdx] = next;
        userData.value.collection = col;
        persistUser();

        const docId = getMyDocId();
        if (!docId) return;

        db.collection('users').doc(docId).update({
          collection: col,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(() => {});
      };

      // ====== member list ======
      const filteredUserList = computed(() => {
        const list = [...userList.value];

        const key = String(searchKeyword.value || '').trim().toLowerCase();
        let out = list;

        if (key) {
          out = out.filter(u => {
            const n = String(u.nickname || '').toLowerCase();
            const s = String(u.server || '');
            return n.includes(key) || s.includes(key);
          });
        }

        // ìµœì‹  ì—…ë°ì´íŠ¸ ìˆœ
        out.sort((a, b) => {
          const ta = asDate(a.lastUpdated)?.getTime() || 0;
          const tb = asDate(b.lastUpdated)?.getTime() || 0;
          return tb - ta;
        });

        return out;
      });

const fetchUsersAndShowList = async () => {
  showUserListPopup.value = true;
  isLoading.value = true;
  searchKeyword.value = '';
  userList.value = [];

  try {
    if (!userData.value) {
      alert("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    const snap = await db.collection('users').get();
    const arr = [];

    snap.forEach(doc => {
      const u = doc.data() || {};

      // nickname ì—†ëŠ” ë¬¸ì„œ ì œì™¸(ì—ëŸ¬ ë°©ì§€)
      if (!u.nickname || typeof u.nickname !== 'string') return;

      // admin ì œì™¸
      if (u.role === 'admin') return;

      // ë‚´ ë¬¸ì„œ ì œì™¸
      const myId = getMyDocId();
      if (doc.id === myId) return;

      const col = normalizeCollection(u.collection);
      const total = col.reduce((a, b) => a + (b > 0 ? 1 : 0), 0);

      // âœ… í•µì‹¬: ì¼ë°˜ ìœ ì €ì¼ ë•ŒëŠ” "ì¹´ë“œ 1ì¥ ì´ìƒ"ë§Œ ë…¸ì¶œ
      if (!isAdmin.value && total < 1) return;

      arr.push({
        id: doc.id,
        server: u.server,
        nickname: u.nickname,
        collection: col,
        totalCount: total,
        lastUpdated: u.lastUpdated || u.lastActive || null
      });
    });

    userList.value = arr;
  } catch (e) {
    console.error("user list load error", e);
    alert("ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: " + (e.message || e));
  } finally {
    isLoading.value = false;
  }
};


      // ====== compare ======
      const openCompare = (targetUser) => {
        showUserListPopup.value = false;
        showPopup.value = false;

        compareTarget.value = targetUser;

        const myCol = normalizeCollection(userData.value.collection);
        const targetCol = normalizeCollection(targetUser.collection);

        const res = { mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] };

        for (let i = 0; i < 81; i++) {
          const aIdx = Math.floor(i / 9);
          const cIdx = (i % 9) + 1;

          const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx + 1}`;
          const cardName = `${albumName} - ì‚¬ì§„${cIdx}`;
          const cardObj = { index: i, name: cardName };

          const iHaveSpare = myCol[i] > 1;
          const iNeed = myCol[i] === 0;

          const uHaveSpare = targetCol[i] > 1;
          const uNeed = targetCol[i] === 0;

          if (iHaveSpare && uNeed) res.giveOnly.push(cardObj);
          if (uHaveSpare && iNeed) res.receiveOnly.push(cardObj);
        }

        if (res.giveOnly.length > 0 && res.receiveOnly.length > 0) {
          res.mutual.give = [...res.giveOnly];
          res.mutual.receive = [...res.receiveOnly];
        }

        compareResult.value = res;
        showComparePopup.value = true;
      };

      const copyTradeText = (card, type) => {
        const myServer = userData.value.server;
        const myName = userData.value.nickname;
        const targetServer = compareTarget.value.server;
        const targetName = compareTarget.value.nickname;

        const text = type === 'give'
          ? `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\n[${card.name}] ë“œë¦´ê²Œìš”! êµí™˜í•˜ì‹¤ë˜ìš”?`
          : `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\ní˜¹ì‹œ [${card.name}] êµí™˜í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?`;

        navigator.clipboard.writeText(text).then(() => {
          alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
        });
      };

      // ====== trade execute ======
      const executeTrade = async (card, type) => {
        await checkAndResetDailyLimit();

        if (tradeCount.value >= 3) {
          alert("ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ 3íšŒë¥¼ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ì˜¤ì „ 8ì‹œì— ë‹¤ì‹œ ê°€ëŠ¥í•´ìš”! ğŸŒ™");
          return;
        }

        const actionName = type === 'give'
          ? `[${card.name}] ì„(ë¥¼) ì£¼ì‹œê² ìŠµë‹ˆê¹Œ?`
          : `[${card.name}] ì„(ë¥¼) ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`;

        const effect = type === 'give'
          ? "ë‚´ ìˆ˜ëŸ‰ -1 / ìƒëŒ€ ìˆ˜ëŸ‰ +1"
          : "ë‚´ ìˆ˜ëŸ‰ +1 / ìƒëŒ€ ìˆ˜ëŸ‰ -1";

        if (!confirm(`${actionName}\n(${effect})\n\në‚˜ì™€ ìƒëŒ€ë°©ì˜ êµí™˜ íšŸìˆ˜ê°€ 1íšŒì”© ì°¨ê°ë©ë‹ˆë‹¤.`)) return;

        isLoading.value = true;

        try {
          const myDocId = getMyDocId();
          const targetDocId = compareTarget.value?.id;
          if (!myDocId || !targetDocId) throw new Error("ë¬¸ì„œ ID ì—†ìŒ");

          const myDocRef = db.collection('users').doc(myDocId);
          const targetDocRef = db.collection('users').doc(targetDocId);

          const today = getGameDate();

          await db.runTransaction(async (t) => {
            const myDoc = await t.get(myDocRef);
            const targetDoc = await t.get(targetDocRef);
            if (!myDoc.exists || !targetDoc.exists) throw new Error("ë¬¸ì„œ ì—†ìŒ");

            const myData = myDoc.data() || {};
            const targetData = targetDoc.data() || {};

            let myCurrentCount = myData.dailyExchangeCount || 0;
            if (myData.dailyExchangeDate !== today) myCurrentCount = 0;
            if (myCurrentCount >= 3) throw new Error("ì˜¤ëŠ˜ ë‚˜ì˜ êµí™˜ í•œë„ê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!");

            let targetCount = targetData.dailyExchangeCount || 0;
            if (targetData.dailyExchangeDate !== today) targetCount = 0;
            if (targetCount >= 3) throw new Error(`ìƒëŒ€ë°©(${targetData.nickname}ë‹˜)ì˜ ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            const myCol = normalizeCollection(myData.collection);
            const targetCol = normalizeCollection(targetData.collection);
            const idx = card.index;

            if (type === 'give') {
              if (myCol[idx] < 1) throw new Error("ì˜¤ë¥˜: ë‚´ ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!");
              myCol[idx]--; targetCol[idx]++;
            } else {
              if (targetCol[idx] < 1) throw new Error("ì˜¤ë¥˜: ìƒëŒ€ë°© ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!");
              myCol[idx]++; targetCol[idx]--;
            }

            const now = firebase.firestore.FieldValue.serverTimestamp();
            const myNewCount = myCurrentCount + 1;
            const targetNewCount = targetCount + 1;

            t.update(myDocRef, {
              collection: myCol,
              dailyExchangeCount: myNewCount,
              dailyExchangeDate: today,
              lastUpdated: now
            });

            t.update(targetDocRef, {
              collection: targetCol,
              dailyExchangeCount: targetNewCount,
              dailyExchangeDate: today,
              lastUpdated: now
            });

            // local state update
            userData.value.collection = myCol;
            userData.value.dailyExchangeCount = myNewCount;
            userData.value.dailyExchangeDate = today;
            tradeCount.value = myNewCount;

            compareTarget.value.collection = targetCol;
          });

          persistUser();
          updateLastActive();

          alert(`ê±°ë˜ ì™„ë£Œ! (ì˜¤ëŠ˜ ${tradeCount.value}/3íšŒ ì™„ë£Œ)`);
          openCompare(compareTarget.value);

        } catch (e) {
          console.error("trade fail", e);
          alert("ê±°ë˜ ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      // ====== exchange helper (when card count 0 click) ======
      const checkExchange = async (i) => {
        if (!userData.value) return;

        const col = normalizeCollection(userData.value.collection);
        const realIdx = currentAlbumIdx.value * 9 + i;

        // ì´ë¯¸ ê°€ì§€ê³  ìˆìœ¼ë©´ íŒì—… ì•ˆë„ì›€
        if (col[realIdx] > 0) return;

        targetCardIdx.value = i;
        showPopup.value = true;
        exchangeList.value = [];
        isLoading.value = true;

        try {
          const snap = await db.collection('users').get();
          const matches = [];

          snap.forEach(doc => {
            const u = doc.data() || {};

            // ì´ìƒ ë¬¸ì„œ ì œì™¸
            if (!u.nickname || typeof u.nickname !== 'string') return;
            if (u.role === 'admin') return;

            const myId = getMyDocId();
            if (doc.id === myId) return;

            const uCol = normalizeCollection(u.collection);

            // ìƒëŒ€ê°€ ì—¬ë¶„(2ì¥ ì´ìƒ) ê°€ì§€ê³  ìˆëŠ”ì§€
            if ((uCol[realIdx] || 0) > 1) {
              // ë‚´ê°€ ì¤„ ìˆ˜ ìˆëŠ” ê²ƒ(ë‚´ ì—¬ë¶„ && ìƒëŒ€ 0)
              const giveable = [];
              for (let k = 0; k < 81; k++) {
                if ((col[k] || 0) > 1 && (uCol[k] || 0) === 0) {
                  const aIdx = Math.floor(k / 9);
                  const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx + 1}`;
                  giveable.push(`${albumName} - ì‚¬ì§„${(k % 9) + 1}`);
                }
              }

              matches.push({
                id: doc.id,
                server: u.server,
                nickname: u.nickname,
                collection: uCol,
                giveable
              });
            }
          });

          exchangeList.value = matches;
        } catch (e) {
          console.error("exchange load fail", e);
        } finally {
          isLoading.value = false;
        }
      };

      // ====== admin tools ======
      const openAdminTool = async () => {
        if (!isAdmin.value) return;
        showAdminToolPopup.value = true;
        await fetchAdminData();
      };

      const fetchAdminData = async () => {
        if (!isAdmin.value) return;

        isLoading.value = true;
        adminUserList.value = [];
        adminMatchList.value = [];
        adminTargetUserId.value = '';

        try {
          const snap = await db.collection('users').get();
          const arr = [];

          snap.forEach(doc => {
            const u = doc.data() || {};

            // nickname ì—†ëŠ” ë¬¸ì„œ ì œì™¸ (localeCompare ë°©ì§€)
            if (!u.nickname || typeof u.nickname !== 'string') return;

            // admin ì œì™¸
            if (u.role === 'admin') return;

            const col = normalizeCollection(u.collection);
            const total = col.reduce((a, b) => a + (b > 0 ? 1 : 0), 0);

            arr.push({
              id: doc.id,
              server: u.server,
              nickname: u.nickname,
              collection: col,
              totalCount: total,
              lastUpdated: u.lastUpdated || u.lastActive || null
            });
          });

          // âœ… ì•ˆì „ ì •ë ¬
          arr.sort((a, b) => (a.nickname || '').localeCompare((b.nickname || '')));

          adminUserList.value = arr;
        } catch (e) {
          console.error("admin data load fail", e);
          alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const calculateAdminMatches = () => {
        if (!adminTargetUserId.value) return;

        const targetUser = adminUserList.value.find(u => u.id === adminTargetUserId.value);
        if (!targetUser) return;

        const matches = [];

        adminUserList.value.forEach(donor => {
          if (donor.id === targetUser.id) return;

          const giveable = [];

          for (let i = 0; i < 81; i++) {
            if ((donor.collection[i] || 0) > 1 && (targetUser.collection[i] || 0) === 0) {
              const aIdx = Math.floor(i / 9);
              const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx + 1}`;
              giveable.push({ index: i, name: `${albumName} - ì‚¬ì§„${(i % 9) + 1}` });
            }
          }

          if (giveable.length > 0) matches.push({ user: donor, giveable });
        });

        adminMatchList.value = matches;
      };

      const executeAdminTransfer = async (match) => {
        if (!confirm(`S${match.user.server} ${match.user.nickname}ë‹˜ì˜ ì¹´ë“œ ${match.giveable.length}ì¥ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        isLoading.value = true;

        try {
          const targetUserRef = db.collection('users').doc(adminTargetUserId.value);
          const donorUserRef = db.collection('users').doc(match.user.id);

          await db.runTransaction(async (t) => {
            const targetDoc = await t.get(targetUserRef);
            const donorDoc = await t.get(donorUserRef);

            if (!targetDoc.exists || !donorDoc.exists) throw new Error("ìœ ì € ì •ë³´ ì—†ìŒ");

            const targetCol = normalizeCollection(targetDoc.data().collection);
            const donorCol = normalizeCollection(donorDoc.data().collection);

            match.giveable.forEach(card => {
              const idx = card.index;
              if (donorCol[idx] > 1) {
                donorCol[idx]--;
                targetCol[idx]++;
              }
            });

            const now = firebase.firestore.FieldValue.serverTimestamp();
            t.update(targetUserRef, { collection: targetCol, lastUpdated: now });
            t.update(donorUserRef, { collection: donorCol, lastUpdated: now });
          });

          alert("ì´ë™ ì™„ë£Œ! âš¡");

          await fetchAdminData();
          adminTargetUserId.value = '';
          adminMatchList.value = [];

        } catch (e) {
          console.error("admin transfer fail", e);
          alert("ì˜¤ë¥˜ ë°œìƒ: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const resetAllUsers = async () => {
        if (!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        isLoading.value = true;

        try {
          const snap = await db.collection('users').get();
          const updates = [];

          snap.forEach(doc => {
            const u = doc.data() || {};
            // nickname ì—†ê±°ë‚˜ adminì´ë©´ ì œì™¸(ì•ˆì „)
            if (!u.nickname || typeof u.nickname !== 'string') return;
            if (u.role === 'admin') return;

            updates.push(doc.ref.update({
              collection: Array(81).fill(0),
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }));
          });

          await Promise.all(updates);

          // ë‚´ ìƒíƒœë„ 0ìœ¼ë¡œ
          if (userData.value && !isAdmin.value) {
            userData.value.collection = Array(81).fill(0);
            persistUser();
          }

          alert("ì™„ë£Œ");
          showAdminPopup.value = false;

        } catch (e) {
          console.error("reset fail", e);
          alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      // ====== start ======
      checkLogin();

      // ====== expose ======
      return {
        // state
        isLoggedIn, isLoading,
        loginForm, userData, isAdmin,
        currentView, currentAlbumIdx,
        tradeCount,

        // config
        appConfig, saveAppConfig, resetAllUsers,

        // ui popups
        showPopup, showUserListPopup, showComparePopup, showAdminPopup, showHelpPopup, showAdminToolPopup,

        // computed
        currentAlbumCards, totalCount, totalProgress, filteredUserList,

        // actions
        handleLogin, logout,
        openAlbum, prevAlbum, nextAlbum,
        updateCount, getAlbumCount,
        fetchUsersAndShowList, openCompare,
        executeTrade, copyTradeText,
        checkExchange,

        // helpers
        targetCardIdx, exchangeList,
        userList, searchKeyword,
        compareTarget, compareResult,
        getTimeAgo, getActiveColor,

        // admin tool
        openAdminTool, fetchAdminData,
        adminUserList, adminTargetUserId, adminMatchList,
        calculateAdminMatches, executeAdminTransfer
      };
    }
  }).mount('#app');
</script>

</body>
</html>

