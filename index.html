<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” ê´€ë¦¬ì</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    [v-cloak] { display: none !important; }
    body { background-color: #eef2f6; font-family: 'Apple SD Gothic Neo', sans-serif; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ec4899; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .btn-press:active { transform: scale(0.95); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .gauge-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-disabled { background-color: #d1d5db !important; color: #9ca3af !important; cursor: not-allowed; transform: none !important; }
  </style>
</head>

<body>
<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative flex flex-col overflow-hidden">

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div v-if="!isLoggedIn" class="p-8 flex flex-col justify-center h-screen bg-pink-50 relative">
    <button @click="showHelpPopup = true" class="absolute top-4 right-4 text-gray-400 text-sm flex flex-col items-center">
      <i class="fas fa-question-circle text-xl mb-1"></i><span class="text-xs">ë„ì›€ë§</span>
    </button>
    <div class="text-center mb-10">
      <span class="text-4xl">ğŸ‘¸</span>
      <h1 class="text-3xl font-bold text-pink-600 mt-2">ì˜¤í”¼ìŠ¤í€¸<br>ì•¨ë²” êµí™˜ì†Œ</h1>
    </div>
    <div class="space-y-4">
      <input v-model="loginForm.server" type="number" placeholder="ì„œë²„ ë²ˆí˜¸ (ìˆ«ì)"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.nickname" type="text" placeholder="ë‹‰ë„¤ì„ (ê´€ë¦¬ìëŠ” 'ê´€ë¦¬ì')"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.password" type="password" maxlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬"
             class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <button @click="handleLogin"
              class="w-full bg-gradient-to-r from-pink-500 to-pink-400 text-white p-4 rounded-xl font-bold hover:from-pink-600 hover:to-pink-500 transition shadow-md flex justify-center items-center"
              :disabled="isLoading">
        <div v-if="isLoading" class="loader mr-2 border-white border-t-transparent"></div>
        <span>{{ isLoading ? 'ë¡œë”©ì¤‘...' : 'ì…ì¥í•˜ê¸°' }}</span>
      </button>
    </div>
    <p class="text-xs text-gray-400 text-center mt-6">ì„œë²„/ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
  </div>

  <!-- ë©”ì¸ -->
  <div v-else class="flex flex-col h-screen bg-[#f0f9ff]">

    <div class="sticky top-0 bg-white/90 backdrop-blur-sm z-20 border-b border-blue-100 p-3 shadow-sm flex-none">
      <div class="flex justify-between items-center mb-2">
        <div class="flex flex-col">
          <span class="font-bold text-gray-700 text-sm flex items-center">
            <span v-if="isAdmin" class="text-red-500 mr-1 text-lg">ğŸ‘‘</span>
            <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs mr-1 font-bold">S{{ userData.server }}</span>
            {{ userData.nickname }}ë‹˜
          </span>
          <span class="text-[10px] font-bold mt-1" :class="tradeCount >= 3 ? 'text-red-500' : 'text-green-600'">
            <i class="fas fa-sync-alt mr-1"></i>
            ì˜¤ëŠ˜ êµí™˜ {{ tradeCount }}/3 {{ tradeCount >= 3 ? '(ë§ˆê°)' : '' }}
          </span>
        </div>

        <div class="flex gap-2 items-center">
          <button @click="showHelpPopup = true" class="text-gray-400 hover:text-blue-500"><i class="fas fa-question-circle text-lg"></i></button>
          <button @click="fetchUsersAndShowList" class="text-xs bg-blue-500 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm hover:bg-blue-600 transition">ğŸ‘¥ ë©¤ë²„</button>

          <template v-if="isAdmin">
            <button @click="openAdminTool" class="text-xs bg-yellow-500 text-white px-2 py-1.5 rounded-lg shadow-sm font-bold">ğŸ‘‘ ë„êµ¬</button>
            <button @click="showAdminPopup = true" class="text-xs bg-gray-600 text-white px-2 py-1.5 rounded-lg shadow-sm">âš™ï¸</button>
          </template>

          <button @click="logout" class="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">ë‚˜ê°€ê¸°</button>
        </div>
      </div>

      <div class="relative w-full h-7 bg-gray-200 rounded-full shadow-inner overflow-hidden border border-gray-300">
        <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 gauge-fill"
             :style="{ width: totalProgress + '%' }"></div>
        <div class="absolute inset-0 flex items-center justify-center text-xs font-extrabold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.6)] z-10">
          ì „ì²´ ìˆ˜ì§‘ë¥  {{ totalCount }}/81 ({{ totalProgress }}%)
        </div>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto hide-scroll p-4 pb-20">
      <!-- ëŒ€ì‹œë³´ë“œ(ì•¨ë²” 9ê°œ) -->
      <div v-if="currentView === 'dashboard'" class="grid grid-cols-3 gap-x-2 gap-y-6">
        <div v-for="(album, idx) in appConfig.albumNames" :key="idx"
             @click="openAlbum(idx)" class="flex flex-col items-center cursor-pointer group">
          <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg overflow-hidden relative bg-white group-hover:scale-105 transition duration-200 ring-2 ring-gray-100">
            <img v-if="appConfig.albumCovers && appConfig.albumCovers[idx]" :src="appConfig.albumCovers[idx]" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center bg-blue-50 text-3xl text-blue-200">ğŸ“</div>
            <div v-if="getAlbumCount(idx) === 9" class="absolute inset-0 bg-black/30 flex items-center justify-center">
              <i class="fas fa-check text-2xl text-green-400 drop-shadow-md"></i>
            </div>
          </div>
          <div class="mt-2 mb-1 px-2 py-0.5 rounded bg-white/50 backdrop-blur-sm">
            <span class="text-[11px] font-bold text-gray-700 text-center block truncate max-w-[80px]">{{ album }}</span>
          </div>
          <div class="w-20 h-4 bg-gray-600 rounded-full relative border border-white shadow-sm overflow-hidden">
            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full gauge-fill"
                 :style="{ width: (getAlbumCount(idx) / 9) * 100 + '%' }"></div>
            <span class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-[0_1px_1px_rgba(0,0,0,0.5)]">
              {{ getAlbumCount(idx) }}/9
            </span>
          </div>
        </div>
      </div>

      <!-- ìƒì„¸(ì¹´ë“œ 9ì¥) -->
      <div v-if="currentView === 'detail'">
        <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-xl shadow-sm border border-blue-100">
          <button @click="prevAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h2 class="text-sm font-bold text-gray-800">{{ appConfig.albumNames[currentAlbumIdx] }}</h2>
          <button @click="nextAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="grid grid-cols-3 gap-1.5">
          <div v-for="(count, i) in currentAlbumCards" :key="i"
               class="bg-white rounded-lg p-1.5 shadow-sm border border-gray-100 flex flex-col h-28 relative">
            <div class="flex-1 bg-gray-50 rounded mb-1.5 relative overflow-hidden cursor-pointer border border-gray-200 group"
                 @click="checkExchange(i)">
              <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                <span class="text-[9px]">ì‚¬ì§„</span><span class="text-xs font-bold">{{ i + 1 }}</span>
              </div>
              <div v-if="count === 0" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-red-500 font-bold z-10 group-hover:bg-white/70 transition">
                <i class="fas fa-search text-lg mb-1"></i><span class="text-[9px]">êµ¬í•´ìš”</span>
              </div>
            </div>

            <div class="flex items-center justify-between bg-gray-50 rounded-full p-0.5 border border-gray-200">
              <button @click="updateCount(i, -1)"
                      class="w-5 h-5 rounded-full bg-white shadow-sm text-gray-500 flex items-center justify-center text-xs border border-gray-200 btn-press font-bold">-</button>
              <span class="flex-1 text-center text-xs font-bold" :class="count > 0 ? 'text-blue-600' : 'text-gray-300'">{{ count }}</span>
              <button @click="updateCount(i, 1)"
                      class="w-5 h-5 rounded-full bg-blue-500 shadow-sm text-white flex items-center justify-center text-xs btn-press font-bold border-none">+</button>
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-center">
          <button @click="currentView = 'dashboard'"
                  class="px-6 py-2 bg-gray-800 text-white text-xs rounded-full font-bold shadow-lg hover:bg-gray-700 transition flex items-center">
            <i class="fas fa-th-large mr-2"></i> ì•¨ë²” ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- (íŒì—…ë“¤ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€) -->
  <!-- ... ì¤‘ê°„ íŒì—… HTMLì€ ì‚¬ìš©ì ì½”ë“œ ê·¸ëŒ€ë¡œë¼ì„œ ìƒëµ ì—†ì´ ìœ ì§€í•´ë„ ë¨ -->
  <!-- ì•„ë˜ scriptëŠ” ì „ì²´ êµì²´ê°€ í•µì‹¬ì´ë‹ˆ, HTML íŒì—… ë¶€ë¶„ì€ ë„ˆ ì›ë³¸ ê·¸ëŒ€ë¡œ ì¨ë„ OK -->

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCFV593GWa2VoOf4IqMhVmbW2BGQqkDsE4",
    authDomain: "office-queen-album.firebaseapp.com",
    projectId: "office-queen-album",
    storageBucket: "office-queen-album.firebasestorage.app",
    messagingSenderId: "936201723618",
    appId: "1:936201723618:web:e4ec53040d668f023988bb",
    measurementId: "G-CEENHZG8HZ"
  };

  const ADMIN_PASSWORD = "1299";

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const { createApp, ref, computed } = Vue;

  createApp({
    setup() {
      const isLoggedIn = ref(false);
      const isLoading = ref(false);
      const currentView = ref('dashboard');
      const loginForm = ref({ server: '', nickname: '', password: '' });
      const userData = ref(null);
      const currentAlbumIdx = ref(0);
      const tradeCount = ref(0);

      const showPopup = ref(false);
      const showUserListPopup = ref(false);
      const showComparePopup = ref(false);
      const showAdminPopup = ref(false);
      const showHelpPopup = ref(false);
      const showAdminToolPopup = ref(false);

      const adminUserList = ref([]);
      const adminTargetUserId = ref('');
      const adminMatchList = ref([]);

      const targetCardIdx = ref(0);
      const exchangeList = ref([]);
      const userList = ref([]);
      const compareTarget = ref(null);
      const compareResult = ref({ mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] });
      const searchKeyword = ref('');

      const appConfig = ref({
        albumNames: Array(9).fill().map((_, i) => `ì•¨ë²” ${i+1}`),
        albumCovers: Array(9).fill("")
      });

      // âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì•ˆì „í™”(íƒ€ì„ìŠ¤íƒ¬í”„ ì œê±°)
      const saveToLocal = (data) => {
        const safe = { ...data };
        // firestore timestamp/í•„ë“œ ì œê±°(ê¹¨ì§ˆ ìˆ˜ ìˆì–´ì„œ)
        delete safe.createdAt;
        delete safe.lastActive;
        delete safe.lastUpdated;
        localStorage.setItem('oq_user_v4', JSON.stringify(safe));
      };

      // ê²Œì„ ë‚ ì§œ(ì˜¤ì „ 8ì‹œ ê¸°ì¤€)
      const getGameDate = () => {
        const now = new Date();
        if (now.getHours() < 8) now.setDate(now.getDate() - 1);
        return now.toISOString().split('T')[0];
      };

      const getTimeAgo = (timestamp) => {
        if (!timestamp) return 'ê¸°ë¡ ì—†ìŒ';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          const diff = Date.now() - date.getTime();
          const min = 60 * 1000, hour = 60 * min, day = 24 * hour;
          if (diff < 10 * min) return 'ë°©ê¸ˆ ì „ ì—…ë°ì´íŠ¸';
          if (diff < hour) return `${Math.floor(diff / min)}ë¶„ ì „ ì—…ë°ì´íŠ¸`;
          if (diff < day) return `${Math.floor(diff / hour)}ì‹œê°„ ì „ ì—…ë°ì´íŠ¸`;
          return `${Math.floor(diff / day)}ì¼ ì „ ì—…ë°ì´íŠ¸`;
        } catch(e) {
          return 'ê¸°ë¡ ì—†ìŒ';
        }
      };

      const getActiveColor = (timestamp) => {
        if (!timestamp) return 'bg-gray-300';
        try {
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          const diff = Date.now() - date.getTime();
          if (diff < 60 * 60 * 1000) return 'bg-green-500';
          if (diff < 24 * 60 * 60 * 1000) return 'bg-yellow-400';
          return 'bg-gray-300';
        } catch(e) {
          return 'bg-gray-300';
        }
      };

      const isAdmin = computed(() => userData.value && userData.value.role === 'admin');

      const updateLastActive = async () => {
        if (!userData.value || isAdmin.value) return;
        const docId = `S${userData.value.server}_${userData.value.nickname}`;
        try {
          await db.collection('users').doc(docId).update({
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch(e) {}
      };

      const checkAndResetDailyLimit = async () => {
        if (!userData.value || isAdmin.value) return;
        const today = getGameDate();
        if (userData.value.dailyExchangeDate !== today) {
          userData.value.dailyExchangeCount = 0;
          userData.value.dailyExchangeDate = today;
          tradeCount.value = 0;
          const docId = `S${userData.value.server}_${userData.value.nickname}`;
          try {
            await db.collection('users').doc(docId).update({ dailyExchangeCount: 0, dailyExchangeDate: today });
          } catch(e) {}
        } else {
          tradeCount.value = userData.value.dailyExchangeCount || 0;
        }
      };

      const loadAppConfig = async () => {
        try {
          const doc = await db.collection('config').doc('service_info').get();
          if (doc.exists) {
            const data = doc.data();
            if (data.albumNames) appConfig.value.albumNames = data.albumNames;
            if (data.albumCovers) appConfig.value.albumCovers = data.albumCovers;
          }
        } catch(e) {}
      };

      const filteredUserList = computed(() => {
        if (!userList.value.length) return [];
        let list = userList.value;
        if (searchKeyword.value) {
          const keyword = searchKeyword.value.toLowerCase();
          list = list.filter(u => u.nickname.toLowerCase().includes(keyword) || String(u.server).includes(keyword));
        }
        list.sort((a,b) => {
          const A = a.lastUpdated ? (a.lastUpdated.toMillis ? a.lastUpdated.toMillis() : new Date(a.lastUpdated).getTime()) : 0;
          const B = b.lastUpdated ? (b.lastUpdated.toMillis ? b.lastUpdated.toMillis() : new Date(b.lastUpdated).getTime()) : 0;
          return B - A;
        });
        return list;
      });

      const fetchUsersAndShowList = async () => {
        showUserListPopup.value = true;
        isLoading.value = true;
        searchKeyword.value = '';
        userList.value = [];
        try {
          const snapshot = await db.collection('users').get();
          const users = [];
          snapshot.forEach(doc => {
            const u = doc.data();
            if (!userData.value) return;
            if (u.nickname !== userData.value.nickname && u.role !== 'admin') {
              const total = (u.collection || []).reduce((a,b) => a + (b>0?1:0), 0);
              users.push({ id: doc.id, ...u, totalCount: total });
            }
          });
          userList.value = users;
        } catch (e) {
          alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      // ê´€ë¦¬ì ë„êµ¬
      const openAdminTool = () => {
        if (!isAdmin.value) return;
        showAdminToolPopup.value = true;
        fetchAdminData();
      };

      const fetchAdminData = async () => {
        if (!isAdmin.value) return;
        isLoading.value = true;
        adminUserList.value = [];
        adminMatchList.value = [];
        adminTargetUserId.value = '';
        try {
          const snapshot = await db.collection('users').get();
          const users = [];
          snapshot.forEach(doc => {
            const u = doc.data();
            if (u.role !== 'admin') {
              const total = (u.collection || []).reduce((a,b) => a + (b>0?1:0), 0);
              users.push({ id: doc.id, ...u, totalCount: total });
            }
          });
          users.sort((a,b) => a.nickname.localeCompare(b.nickname));
          adminUserList.value = users;
        } catch (e) {
          alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      const calculateAdminMatches = () => {
        if (!adminTargetUserId.value) return;
        const targetUser = adminUserList.value.find(u => u.id === adminTargetUserId.value);
        if (!targetUser) return;

        const matches = [];
        adminUserList.value.forEach(donor => {
          if (donor.id === targetUser.id) return;
          const giveable = [];
          for (let i=0; i<81; i++) {
            if ((donor.collection[i] || 0) > 1 && (targetUser.collection[i] || 0) === 0) {
              const aIdx = Math.floor(i/9);
              const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`;
              giveable.push({ index: i, name: `${albumName} - ì‚¬ì§„${(i%9)+1}` });
            }
          }
          if (giveable.length > 0) matches.push({ user: donor, giveable });
        });
        adminMatchList.value = matches;
      };

      const executeAdminTransfer = async (match) => {
        if (!confirm(`S${match.user.server} ${match.user.nickname}ë‹˜ì˜ ì¹´ë“œ ${match.giveable.length}ì¥ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        isLoading.value = true;
        try {
          const targetUserRef = db.collection('users').doc(adminTargetUserId.value);
          const donorUserRef = db.collection('users').doc(match.user.id);

          await db.runTransaction(async (t) => {
            const targetDoc = await t.get(targetUserRef);
            const donorDoc = await t.get(donorUserRef);
            if (!targetDoc.exists || !donorDoc.exists) throw new Error("ìœ ì € ì •ë³´ ì—†ìŒ");
            const targetCol = targetDoc.data().collection || Array(81).fill(0);
            const donorCol = donorDoc.data().collection || Array(81).fill(0);

            match.giveable.forEach(card => {
              const idx = card.index;
              if ((donorCol[idx] || 0) > 1) { donorCol[idx]--; targetCol[idx]++; }
            });

            const now = firebase.firestore.FieldValue.serverTimestamp();
            t.update(targetUserRef, { collection: targetCol, lastUpdated: now });
            t.update(donorUserRef, { collection: donorCol, lastUpdated: now });
          });

          alert("ì´ë™ ì™„ë£Œ! âš¡");
          await fetchAdminData();
          adminTargetUserId.value = '';
        } catch (e) {
          alert("ì˜¤ë¥˜ ë°œìƒ: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      // ë¹„êµ íŒì—…
      const openCompare = (targetUser) => {
        showUserListPopup.value = false;
        showPopup.value = false;
        compareTarget.value = targetUser;

        const myCol = userData.value.collection || Array(81).fill(0);
        const targetCol = targetUser.collection || Array(81).fill(0);

        const res = { mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] };

        for (let i=0; i<81; i++) {
          const aIdx = Math.floor(i/9);
          const cIdx = (i%9)+1;
          const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`;
          const cardName = `${albumName} - ì‚¬ì§„${cIdx}`;
          const cardObj = { index: i, name: cardName };

          const iHaveSpare = myCol[i] > 1;
          const iNeed = myCol[i] === 0;
          const uHaveSpare = targetCol[i] > 1;
          const uNeed = targetCol[i] === 0;

          if (iHaveSpare && uNeed) res.giveOnly.push(cardObj);
          if (uHaveSpare && iNeed) res.receiveOnly.push(cardObj);
        }

        if (res.giveOnly.length > 0 && res.receiveOnly.length > 0) {
          res.mutual.give = [...res.giveOnly];
          res.mutual.receive = [...res.receiveOnly];
        }

        compareResult.value = res;
        showComparePopup.value = true;
      };

      const copyTradeText = (card, type) => {
        const myServer = userData.value.server;
        const myName = userData.value.nickname;
        const targetServer = compareTarget.value.server;
        const targetName = compareTarget.value.nickname;
        const text = type === 'give'
          ? `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\n[${card.name}] ë“œë¦´ê²Œìš”! êµí™˜í•˜ì‹¤ë˜ìš”?`
          : `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\ní˜¹ì‹œ [${card.name}] êµí™˜í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?`;
        navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”."));
      };

      const executeTrade = async (card, type) => {
        await checkAndResetDailyLimit();
        if (tradeCount.value >= 3) {
          alert("ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ 3íšŒë¥¼ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ì˜¤ì „ 8ì‹œì— ë‹¤ì‹œ ê°€ëŠ¥í•´ìš”! ğŸŒ™");
          return;
        }

        const actionName = type === 'give' ? `[${card.name}] ì„(ë¥¼) ì£¼ì‹œê² ìŠµë‹ˆê¹Œ?` : `[${card.name}] ì„(ë¥¼) ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`;
        const effect = type === 'give' ? "ë‚´ ìˆ˜ëŸ‰ -1 / ìƒëŒ€ ìˆ˜ëŸ‰ +1" : "ë‚´ ìˆ˜ëŸ‰ +1 / ìƒëŒ€ ìˆ˜ëŸ‰ -1";

        if (!confirm(`${actionName}\n(${effect})\n\në‚˜ì™€ ìƒëŒ€ë°©ì˜ êµí™˜ íšŸìˆ˜ê°€ 1íšŒì”© ì°¨ê°ë©ë‹ˆë‹¤.`)) return;

        isLoading.value = true;

        try {
          const myDocId = isAdmin.value ? 'MASTER_ADMIN' : `S${userData.value.server}_${userData.value.nickname}`;
          const myDocRef = db.collection('users').doc(myDocId);
          const targetDocRef = db.collection('users').doc(compareTarget.value.id);

          const today = getGameDate();

          await db.runTransaction(async (transaction) => {
            const myDoc = await transaction.get(myDocRef);
            const targetDoc = await transaction.get(targetDocRef);

            if (!myDoc.exists || !targetDoc.exists) throw new Error("ë¬¸ì„œ ì—†ìŒ");

            const myData = myDoc.data();
            const targetData = targetDoc.data();

            let myCurrentCount = myData.dailyExchangeCount || 0;
            if (myData.dailyExchangeDate !== today) myCurrentCount = 0;
            if (myCurrentCount >= 3) throw new Error("ì˜¤ëŠ˜ ë‚˜ì˜ êµí™˜ í•œë„ê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!");

            let targetCount = targetData.dailyExchangeCount || 0;
            if (targetData.dailyExchangeDate !== today) targetCount = 0;
            if (targetCount >= 3) throw new Error(`ìƒëŒ€ë°©(${targetData.nickname}ë‹˜)ì˜ ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            const myCol = myData.collection || Array(81).fill(0);
            const targetCol = targetData.collection || Array(81).fill(0);

            const idx = card.index;

            if (type === 'give') {
              if ((myCol[idx] || 0) < 1) throw new Error("ì˜¤ë¥˜: ë‚´ ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!");
              myCol[idx]--; targetCol[idx]++;
            } else {
              if ((targetCol[idx] || 0) < 1) throw new Error("ì˜¤ë¥˜: ìƒëŒ€ë°© ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!");
              myCol[idx]++; targetCol[idx]--;
            }

            const myNewCount = myCurrentCount + 1;
            const targetNewCount = targetCount + 1;

            const now = firebase.firestore.FieldValue.serverTimestamp();
            transaction.update(myDocRef, { collection: myCol, dailyExchangeCount: myNewCount, dailyExchangeDate: today, lastUpdated: now });
            transaction.update(targetDocRef, { collection: targetCol, dailyExchangeCount: targetNewCount, dailyExchangeDate: today, lastUpdated: now });

            userData.value.collection = myCol;
            userData.value.dailyExchangeCount = myNewCount;
            userData.value.dailyExchangeDate = today;
            tradeCount.value = myNewCount;
            compareTarget.value.collection = targetCol;
          });

          saveToLocal(userData.value);
          updateLastActive();
          alert(`ê±°ë˜ ì™„ë£Œ! (ì˜¤ëŠ˜ ${tradeCount.value}/3íšŒ ì™„ë£Œ)`);
          openCompare(compareTarget.value);
        } catch (e) {
          alert("ê±°ë˜ ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      const saveAppConfig = async () => {
        if (!confirm("ì €ì¥í• ê¹Œìš”?")) return;
        try {
          await db.collection('config').doc('service_info').set(appConfig.value);
          alert("ì €ì¥ë¨");
          showAdminPopup.value = false;
        } catch (e) {
          alert("ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        }
      };

      const resetAllUsers = async () => {
        if (!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        isLoading.value = true;
        try {
          const snap = await db.collection('users').get();
          const updates = [];
          snap.forEach(doc => updates.push(doc.ref.update({ collection: Array(81).fill(0) })));
          await Promise.all(updates);

          if (userData.value) {
            userData.value.collection = Array(81).fill(0);
            saveToLocal(userData.value);
          }
          alert("ì™„ë£Œ");
          showAdminPopup.value = false;
        } catch (e) {
          alert("ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      // âœ… ë¡œê·¸ì¸: ê¸°ì¡´ ìœ ì €ì— password í•„ë“œ ì—†ìœ¼ë©´ ìµœì´ˆ 1íšŒ ì„¸íŒ…
      const handleLogin = async () => {
        if (isLoading.value) return;
        const { server, nickname, password } = loginForm.value;

        if (!nickname || !password) { alert('ì •ë³´ ì…ë ¥!'); return; }

        if (nickname === 'ê´€ë¦¬ì') {
          if (password !== ADMIN_PASSWORD) { alert("ë¹„ë²ˆ í‹€ë¦¼"); return; }
          await processLogin('MASTER_ADMIN', { nickname: 'ê´€ë¦¬ì', server: 0, password: ADMIN_PASSWORD, role: 'admin' });
          return;
        }

        if (!server) { alert('ì„œë²„ ì…ë ¥!'); return; }

        await processLogin(`S${server}_${nickname}`, { nickname, server, password, role: 'user' });
      };

      const processLogin = async (docId, userInfo) => {
        isLoading.value = true;
        await loadAppConfig();

        const docRef = db.collection('users').doc(docId);

        try {
          const doc = await docRef.get();
          let finalData;

          if (doc.exists) {
            const data = doc.data() || {};

            // âœ… ê¸°ì¡´ ë°ì´í„°ì— passwordê°€ ì—†ìœ¼ë©´ "ìµœì´ˆ 1íšŒ ì„¸íŒ…"
            if (!data.password) {
              await docRef.update({ password: userInfo.password });
              data.password = userInfo.password;
            }

            if (data.password !== userInfo.password) {
              alert('ë¹„ë²ˆ í‹€ë¦¼');
              return;
            }

            // ì˜ˆì „ êµ¬ì¡°ê°€ 2ì°¨ì› ë°°ì—´ë¡œ ë“¤ì–´ê°„ ê²½ìš° ë°©ì–´
            if (Array.isArray(data.collection) && Array.isArray(data.collection[0])) {
              data.collection = Array(81).fill(0);
            }

            // collection ì—†ìœ¼ë©´ ë³´ì •
            if (!Array.isArray(data.collection) || data.collection.length !== 81) {
              data.collection = Array(81).fill(0);
            }

            finalData = data;
          } else {
            finalData = {
              ...userInfo,
              collection: Array(81).fill(0),
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastActive: firebase.firestore.FieldValue.serverTimestamp(),
              dailyExchangeCount: 0,
              dailyExchangeDate: getGameDate()
            };
            await docRef.set(finalData);
          }

          userData.value = finalData;
          saveToLocal(finalData);

          if (finalData.role !== 'admin') await checkAndResetDailyLimit();
          updateLastActive();

          isLoggedIn.value = true;
          if (finalData.role === 'admin') fetchAdminData();
        } catch (e) {
          alert('ì˜¤ë¥˜: ' + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      const checkLogin = async () => {
        const savedUser = localStorage.getItem('oq_user_v4');
        if (savedUser) {
          try {
            userData.value = JSON.parse(savedUser);
            await loadAppConfig();
            if (userData.value.role !== 'admin') await checkAndResetDailyLimit();
            isLoggedIn.value = true;
            updateLastActive();
            if (userData.value.role === 'admin') fetchAdminData();
          } catch(e) {}
        }
      };
      checkLogin();

      const logout = () => {
        localStorage.removeItem('oq_user_v4');
        userData.value = null;
        isLoggedIn.value = false;
        loginForm.value = { server: '', nickname: '', password: '' };
      };

      const currentAlbumCards = computed(() =>
        userData.value ? userData.value.collection.slice(currentAlbumIdx.value * 9, (currentAlbumIdx.value * 9) + 9) : []
      );

      // ì¹´ë“œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ + lastUpdated ì €ì¥
      const updateCount = (i, chg) => {
        if (!userData.value) return;

        const idx = (currentAlbumIdx.value * 9) + i;
        if ((userData.value.collection[idx] || 0) + chg < 0) return;

        userData.value.collection[idx] = (userData.value.collection[idx] || 0) + chg;

        saveToLocal(userData.value);

        const docId = userData.value.role === 'admin'
          ? 'MASTER_ADMIN'
          : `S${userData.value.server}_${userData.value.nickname}`;

        db.collection('users').doc(docId).update({
          collection: userData.value.collection,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(() => {});
      };

      const getAlbumCount = (idx) =>
        userData.value ? userData.value.collection.slice(idx * 9, idx * 9 + 9).filter(c => c > 0).length : 0;

      const totalCount = computed(() => userData.value ? userData.value.collection.filter(c => c > 0).length : 0);
      const totalProgress = computed(() => Math.round((totalCount.value / 81) * 100));

      const openAlbum = (idx) => { currentAlbumIdx.value = idx; currentView.value = 'detail'; };
      const prevAlbum = () => { if (currentAlbumIdx.value > 0) currentAlbumIdx.value--; };
      const nextAlbum = () => { if (currentAlbumIdx.value < 8) currentAlbumIdx.value++; };

      const checkExchange = async (i) => {
        const rIdx = (currentAlbumIdx.value * 9) + i;
        if (userData.value.collection[rIdx] > 0) return;

        targetCardIdx.value = i;
        showPopup.value = true;
        exchangeList.value = [];
        isLoading.value = true;

        try {
          const snap = await db.collection('users').get();
          const matches = [];

          snap.forEach(doc => {
            const u = doc.data() || {};
            if (!u.nickname || !Array.isArray(u.collection)) return;
            if (u.nickname === userData.value.nickname) return;

            if ((u.collection[rIdx] || 0) > 1) {
              const giveable = [];
              for (let k=0; k<81; k++) {
                if ((userData.value.collection[k] || 0) > 1 && (u.collection[k] || 0) === 0) {
                  const aIdx = Math.floor(k/9);
                  const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`;
                  giveable.push(`${albumName} - ì‚¬ì§„${(k%9)+1}`);
                }
              }
              matches.push({
                id: doc.id,
                server: u.server,
                nickname: u.nickname,
                collection: u.collection,
                giveable
              });
            }
          });

          exchangeList.value = matches;
        } catch(e) {
          alert("ì¡°íšŒ ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
        } finally {
          isLoading.value = false;
        }
      };

      // âœ… returnì— getActiveText ì œê±°(ì •ì˜ ì•ˆ ë˜ì–´ ìˆì–´ì„œ í„°ì§€ë˜ ë¶€ë¶„)
      return {
        isLoggedIn, isLoading, loginForm, handleLogin, logout, userData, isAdmin,
        currentView, currentAlbumIdx, currentAlbumCards, appConfig,
        openAlbum, prevAlbum, nextAlbum, updateCount, getAlbumCount, totalCount, totalProgress,
        checkExchange,

        showPopup, showAdminPopup, showUserListPopup, showComparePopup, showHelpPopup,
        showAdminToolPopup, openAdminTool,

        targetCardIdx, exchangeList, userList, compareTarget, compareResult,
        saveAppConfig, resetAllUsers, fetchUsersAndShowList, openCompare, executeTrade, copyTradeText,
        searchKeyword, filteredUserList, getActiveColor, tradeCount, getTimeAgo,

        adminUserList, adminTargetUserId, adminMatchList, calculateAdminMatches, executeAdminTransfer, fetchAdminData
      };
    }
  }).mount('#app');
</script>

</body>
</html>
